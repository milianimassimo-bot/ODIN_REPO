import os,json,requests;from datetime import datetime,timezone;ROOT=os.path.abspath(os.path.dirname(__file__));PARAMS_DIR=os.path.join(ROOT,'params');os.makedirs(PARAMS_DIR,exist_ok=True);API_KEY=(os.getenv('RAPIDAPI_KEY') or '').strip();HOST=(os.getenv('RAPIDAPI_HOST') or 'economic-events-calendar.p.rapidapi.com').strip();COUNTRIES=[x.strip() for x in (os.getenv('NEWS_COUNTRIES','US,GB,EU').split(',')) if x.strip()];MINI=(os.getenv('NEWS_MIN_IMPACT','high') or 'high').strip().lower();print('[FF] fetch per',COUNTRIES,'min_impact=',MINI);assert API_KEY,'RAPIDAPI_KEY mancante';url=f'https://{HOST}/economic-events/tradingview';h={'x-rapidapi-key':API_KEY,'x-rapidapi-host':HOST};p={'countries':','.join(COUNTRIES)};r=requests.get(url,headers=h,params=p,timeout=20);r.raise_for_status();js=r.json();raw=js.get('result') if isinstance(js,dict) else (js if isinstance(js,list) else []);order={'low':0,'medium':1,'high':2};events=[];f=lambda v:order.get((v or '').lower(),-1)>=order.get(MINI,2);iso=lambda dt:dt.astimezone(timezone.utc).isoformat().replace('+00:00','Z');from datetime import timezone;  # noop to keep import;  \nfor ev in raw:\n    if not isinstance(ev,dict):\n        continue\n    imp=str(ev.get('impact','')).lower()\n    if not f(imp):\n        continue\n    t=ev.get('date') or ev.get('time') or ev.get('datetime')\n    events.append({'currency':ev.get('currency'),'event':ev.get('event') or ev.get('title'),'impact':imp,'time':t})\nout={'asof_utc':iso(datetime.now(timezone.utc)),'countries':COUNTRIES,'min_impact':MINI,'events':events};op=os.path.join(PARAMS_DIR,'news_blackout.json');json.dump(out,open(op,'w',encoding='utf-8'),indent=2,ensure_ascii=False);print(f'âœ… scritto {op} con {len(events)} eventi')